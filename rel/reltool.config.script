%% -*- tab-width: 4;erlang-indent-level: 4;indent-tabs-mode: nil -*-
%% ex: ft=erlang ts=4 sw=4 et
%%
% Licensed under the Apache License, Version 2.0 (the "License"); you may not
% use this file except in compliance with the License. You may obtain a copy of
% the License at
%
%   http://www.apache.org/licenses/LICENSE-2.0
%
% Unless required by applicable law or agreed to in writing, software
% distributed under the License is distributed on an "AS IS" BASIS, WITHOUT
% WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the
% License for the specific language governing permissions and limitations under
% the License.

Cfg = case file:consult("../pkg.vars.config") of
          {ok, Terms} ->
              Terms;
          _Err ->
              []
      end,


%% get version infos
MajorVersion = integer_to_list(proplists:get_value(version_major, Cfg, 0)),
MinorVersion = integer_to_list(proplists:get_value(version_minor, Cfg, 0)),
RevVersion = integer_to_list(proplists:get_value(version_revision, Cfg, 0)),
StageVersion = proplists:get_value(version_stage, Cfg, ""),
RelVersion = proplists:get_value(version_release, Cfg, ""),

%% build the version
BaseVersion = MajorVersion ++ "." ++ MinorVersion ++ "." ++ RevVersion,
SecondaryVersion = StageVersion ++ RelVersion,
Vsn = case os:getenv("RELEASE") of
    "1" ->
        BaseVersion;
    _ ->
        BaseVersion ++ SecondaryVersion
end,

CouchJSName = proplists:get_value(couchjs_name, Cfg, "couchjs"),

[
    {sys, [
            {lib_dirs, ["../src/deps", "../src/apps"]},
            {rel, "couchdb", Vsn,
                [
                    kernel,
                    stdlib,
                    sasl,
                    public_key,
                    ssl,
                    os_mon,
                    crypto,
                    inets,
                    xmerl,
                    runtime_tools,
                    mochiweb,
                    ibrowse,
                    oauth,
                    jiffy,
                    snappy,
                    couch,
                    couch_collate,
                    couch_index,
                    couch_mrview,
                    couch_replicator,
                    couch_dbupdates
                ]},
            {rel, "start_clean", "", [kernel, stdlib]},
            {boot_rel, "couchdb"},
            {profile, embedded},
            {relocatable, true},

            {excl_sys_filters, ["^bin/.*",
                                "^erts.*/bin/(dialyzer|typer)",
                                "^erts.*/doc",
                                "^erts.*/man"]},
            {excl_archive_filters, [".*"]},


            %% dependencies
            {app, mochiweb, [{incl_cond, include}]},
            {app, oauth, [{incl_cond, include}]},
            {app, jiffy, [{incl_cond, include}]},
            {app, snappy, [{incl_cond, include}]},
            {app, ibrowse, [{incl_cond, include}]},

            %% couchdb
            {app, couch, [{incl_cond, include}]},
            {app, couch_collate, [{incl_cond, include}]},
            {app, couch_index, [{incl_cond, include}]},
            {app, couch_mrview, [{incl_cond, include}]},
            {app, couch_replicator, [{incl_cond, include}]},
            {app, couch_dbupdates, [{incl_cond, include}]},
            {app, couch_plugins, [{incl_cond, include}]}

        ]},

    {target_dir, "apache-couchdb"},

    {overlay_vars, "vars.config"},

    {overlay, [
        {mkdir, "log"},
        {mkdir, "run"},
        {mkdir, "data"},

        %% keep empty files
        {copy, "../src/etc/couchdb/empty", "log/KEEP"},
        {copy, "../src/etc/couchdb/empty", "data/KEEP"},

        %% Copy base files for starting and interacting w/ node
        {copy, "../src/deps/node_package/priv/base/erl", "{{erts_vsn}}/bin/erl"},
        {copy, "../src/deps/node_package/priv/base/nodetool", "{{erts_vsn}}/bin/nodetool"},
        {template, "../src/deps/node_package/priv/base/runner", "bin/couchdb"},
        {template, "../src/deps/node_package/priv/base/env.sh", "lib/env.sh"},
        {template, "../src/deps/node_package/priv/base/app_epath.sh", "lib/app_epath.sh"},

        %% config files
        {template, "../src/etc/couchdb/app.config", "etc/app.config"},
        {template, "../src/etc/couchdb/vm.args", "etc/vm.args"},
        {template, "../src/etc/couchdb/couch.ini", "etc/couch.ini"},
        {template, "../src/etc/couchdb/local.ini", "etc/local.ini"},

        %% couchdb data files
        {mkdir, "share"},
        {mkdir, "share/server"},
        {copy, "../src/share/server/main.js", "share/server"},
        {copy, "../src/share/server/main-coffee.js", "share/server"},
        {copy, "../src/share/www", "share"},
        {copy, "../src/apps/couch/priv/" ++ CouchJSName, "bin/" ++ CouchJSName},

        %% misc
        {mkdir, "lib/couch-patches"},
        {copy, "../src/support/couch_rel/ebin/etop_txt.beam", "lib/couch-patches"}

    ]}
].
